---
sidebar_position: 01
---

# MutationObserve 的由来

[MutationObserve](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver) 提供了监视对 DOM 树所做更改的能力。它被设计为旧的 Mutation Events 功能的替代品，该功能是 DOM3 Events 规范的一部分。

# Mutation Events

MutationEvents 目前已经被弃用，不再推荐此功能。虽然一些浏览器可能仍然支持它，但它可能已经从相关的 Web 标准中删除，可能正在被删除，或者可能只是为了兼容性目的而保留。

> 添加 Dom Muatation Listeners 对 document 进行 dom 修改时会严重降低性能，大概导致缓慢 1.5-7 倍

以下为所有的 Mutation Events

```
DOMAttrModified
DOMAttributeNameChanged
DOMCharacterDataModified
DOMElementNameChanged
DOMNodeInserted
DOMNodeInsertedIntoDocument
DOMNodeRemoved
DOMNodeRemovedFromDocument
DOMSubtreeModified
```

可以使用以下方法注册 Mutation Events 的监听函数

```js
element.addEventListener(
  "DOMNodeInserted",
  function (event) {
    // ...
  },
  false
);
```

# 解决方案

所以这时候我们为了避免性能的减缓，就使用了 MutationObserver，其使用方式也相对之前有所改变

# MutatioObserve初始化函数

调用`new MutationObserver(callback)`创建并返回一个 MutationObserver 实例对象

它会在指定的 DOM 需要观察的部分变动时触发回调函数。

## 实例对象的方法

### disconnect()

阻止 MutationObserver 实例继续接收通知，直到再次调用其`observe()`方法，回调函数都不会再被调用。

### observe()

调用该函数会监听 DOM 更改，并匹配给定选项时，触发回调函数接收到相应通知。

### takeRecords()

从 MutationObserver 的通知队列中删除所有回调函数未处理的记录，并将它们返回到新 Array 中。

此方法最常见的使用场景是在断开观察者之前立即获取所有未处理的更改记录，以便在停止观察者时可以处理任何未处理的更改。

# 例子

例子已进行汉化，原出处： [DOM MutationObserver](https://hacks.mozilla.org/2012/05/dom-mutationobserver-reacting-to-dom-changes-without-killing-browser-performance/)

```js
const targetNode = document.getElementById("some-id");

// 观察器的配置（需要观察什么变动）
const config = { attributes: true, childList: true, subtree: true };
//subtree 监听包括target的整个子树
//childList 监听子节点的新增与删除变化
//attributes 监听节点的属性变化

// 当观察到变动时执行的回调函数
const callback = function (mutationsList, observer) {
  for (let mutation of mutationsList) {
    if (mutation.type === "childList") {
      console.log("节点被增加或删除");
    } else if (mutation.type === "attributes") {
      console.log("名为:" + mutation.attributeName + "的属性被修改");
    }
  }
};

// 创建一个观察器实例并传入回调函数
// observe函数会对传入的节点以及所需观察的配置项进行观察
// 发生改变则回调callback函数
const observer = new MutationObserver(callback);

// 以上述配置开始观察目标节点
observer.observe(targetNode, config);

// 可停止观察
observer.disconnect();
```
