---
sidebar_position: 6
---

# 实战 React 数据提取抖音视频

> 本文基于 cxxjackie 提供的理论，再次感谢

之前我们已经在元素规则校验中研究过网页的校验如何解决，这节课我们可以实战一下提取 react 页面的数据

以抖音页面为例[全一 YOU 女团](https://www.douyin.com/user/MS4wLjABAAAA__EF83GW-y2bDHV0jmune1pZFG1TRajSgvywS7KYGbQ),发现抖音是 react 页面

![1](./img/06/1.png)

如何判断是 react 页面？我们可以安装 React Developer Tools

如果不是则显示

![2](./img/06/2.png)

如果是页面则显示

![3](./img/06/3.png)

确定是 react 页面后，我们可以安装插件，然后点击这里

![4](./img/06/4.png)

然后通过

![5](./img/06/5.png)

选择到元素

> 注意，推荐选择到相应元素的最上级，然后一层一层往下或往下逐步查找相关的数据以及事件

我们在这里找到了视频的信息

![6](./img/06/6.png)

这时候我们就可以开始写代码了

首先他第一页是没有 post 的，属于网页渲染出来的数据，但是这时候也可以使用 react 属性提取地址，相对 xhr 劫持会好很多。

我们先获取第一页的内容，然后进行 MutationObserve 监听视频部分的绘制

所以抽离一个函数，专门用于处理视频，

我起名叫 enableObserve，负责将第一页的视频循环调用 handleVideoItem 函数，然后再通过 MutationObserve 函数监听接下来渲染的视频

```js
let videoData = new Map();
function handleVideoItem(item) {
  // 处理函数
}
function enableObserve() {
  const domSelector = ".UFuuTZ1P ul";
  document.querySelectorAll(domSelector + " li").forEach((item) => {
    handleVideoItem(item);
  });
  const targetNode = document.querySelector(domSelector);
  const config = {
    childList: true,
  };
  const callback = function (mutationsList, observer) {
    for (let mutation of mutationsList) {
      if (mutation.type === "childList") {
        mutation.addedNodes.forEach((item) => {
          handleVideoItem(item);
        });
      }
    }
  };
  const observer = new MutationObserver(callback);
  observer.observe(targetNode, config);
}
```

然后我们还需要插入一个按钮，用于提取数据

![7](./img/06/7.png)

这里的 innerHTML 是直接改的网页按钮，然后复制粘贴的

```js
let parenttagert = document.querySelector(".Z0NF3RWY");
let div = document.createElement("div");
div.innerHTML = `<div class="q6zgm94p k-vFWw3W FDOWibym BgSUKoKp"><span class="_891e9d38c00e1b78e2eae43ab8b92359-scss" style="cursor: pointer;">复制视频</span><div class="_421d3aff42f03ac25665dc94de7ceadb-scss _6e84962fcb7da3b1e8100d798c94fd0a-scss" style="display: none;"><div class="a508b8e520c4938b699e76f52758e1b5-scss"><div class="f34e96e88162611d7208f348d4f89234-scss"><img src="//p6.douyinpic.com/img/aweme-qrcode/HfLOWW6996335373702006541~c5_720x720.png?from=1247829622" alt="3.82 wfB:/ 这样子的小风车你们喜欢吗～%%夹子音 %%夹子音挑战 %%夹子音变装 @DOU+小助手 @抖音小助手  https://v.douyin.com/d1FgV77/ 复制此链接，打开Dou音搜索，直接观看视频！" class=""></div></div><div class="c970dfb43b7e68344f353625de339de0-scss"><div class="_6ed090956a2566bf4d47a648b75d87ef-scss">打开抖音扫码或复制口令粘贴给微信/QQ好友</div><div class="_5d025eb178c1c97d99eb9717cb4f0290-scss"><span class="_95cfb8df7d5be42fc93f8f4464a1c648-scss">3.82 wfB:/ 这样子的小风车你们喜欢吗～%%夹子音 %%夹子音挑战 %%夹子音变装 @DOU+小助手 @抖音小助手  https://v.douyin.com/d1FgV77/ 复制此链接，打开Dou音搜索，直接观看视频！</span><button class="abace09bde29f9d2077ba2a9e9e2b67d-scss _3c25ad295260cb707e35da1ec8d93a51-scss _14339689bca6b9eda19c146a14df625e-scss _047cfcad258573fad8a7513577bb9f75-scss"><span>复制</span></button></div></div></div></div>`;
div.onclick = function (event) {
  let text = "";
  // videoData即是选中的视频，是一个Map类型
  for (var videoURL of videoData.values()) {
    text += videoURL + "\n";
  }
  GM_setClipboard(text);
  alert("已设置到剪辑版共" + videoData.size + "个");
};
parenttagert.append(div);
```

接下来我们要开始写核心功能函数了

我对网页插入了一个单选框，这时候 MutationObserve 也会监听到，所以一旦检测到就不进行任何操作

创建单选框后，监听点击事件

一旦发生点击则直接根据 react 属性的 children[0].props.aweInfo 提取出来数据

最后保存到 videoData 的 Map 中去，最后点击复制按钮全部提取出来链接贴到剪辑版


```js
function handleVideoItem(item) {
  if (item.className.indexOf("injectvideo") != -1) {
    return;
  }
  item.classList.add("injectvideo");
  const selectDom = document.createElement("label");
  selectDom.className = "container control-pos";
  selectDom.innerHTML = ` <input  type="checkbox"><div class="checkmark"></div>`;
  selectDom.addEventListener("click", function (event) {
    if (selectDom.children[0].checked) {
      const prop = Object.keys(item).find((p) => p.startsWith("__reactProps"));
      if (prop === undefined) {
        return;
      }
      let info = item[prop].children[0].props.info;
      let videourl = info.video.playApi;
      videourl =
        "https://" +
        videourl
          .replace("https://", "")
          .replace("http://", "")
          .replace("//", "");
      videoData.set(selectDom, videourl);
    } else {
      videoData.delete(selectDom);
    }
  });
  item.append(selectDom);
}
```

那么到这里我们就学会了如何提取react数据来实现提取抖音视频~
