---
sidebar_position: 14
---

# XmlhttpRequest 返回内容监听

本章将学会如何监听 XmlhttpRequest 的返回内容。

# 正文

这是我在国外网站找到的一个小例子

```js
function addXMLRequestCallback(callback) {
  var oldSend, i;
  if (XMLHttpRequest.callbacks) {
    XMLHttpRequest.callbacks.push(callback);
  } else {
    XMLHttpRequest.callbacks = [callback];
    oldSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function () {
      for (i = 0; i < XMLHttpRequest.callbacks.length; i++) {
        XMLHttpRequest.callbacks[i](this);
      }
      oldSend.apply(this, arguments);
    };
  }
}
addXMLRequestCallback(function (xhr) {
  xhr.addEventListener("load", function () {
    if (xhr.readyState == 4 && xhr.status == 200) {
      console.log(xhr.responseURL);
    }
  });
});
```

使用是通过调用`addXMLRequestCallback`传入我们的劫持函数来实现，我们的劫持函数会收到一个 xhr，可以对该 xhr 监听 load 事件，并等待`readyState`为 4,`status`为 200 的时候打印 xhr 的内容(这种状态通常表示请求完毕并且响应正常)，这里我们打印的是 xhr.responseURL，当然你也可以直接打印 xhr，然后查看需要查看哪些属性。

接下来我们来看`addXMLRequestCallback`的实现

```js
//判断XMLHttpRequest对象下是否存在回调列表，存在就push一个回调的函数
if (XMLHttpRequest.callbacks) {
  XMLHttpRequest.callbacks.push(callback);
} else {
  //如果不存在则在xmlhttprequest函数下创建一个回调列表
  //这部分代码只会执行一次，因为创建callbacks后，上面的if会为真，然后将函数push进callbacks。
  XMLHttpRequest.callbacks = [callback];
  oldSend = XMLHttpRequest.prototype.send;
  XMLHttpRequest.prototype.send = function () {
    //循环回调xml内的回调函数
    for (i = 0; i < XMLHttpRequest.callbacks.length; i++) {
      XMLHttpRequest.callbacks[i](this);
    }
    //由于我们复写了send函数，所以当我们在调用原send的函数的时候，需要对其传入this引用
    //而arguments是传入的参数列表
    oldSend.apply(this, arguments);
  };
}
```

那么到这里我们就拆解完毕该xhr监听例子了。
